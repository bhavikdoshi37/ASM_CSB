/*global history */
sap.ui.define([
	"colgate/asm/planning/base/controller/BaseController",
	"sap/ui/model/json/JSONModel",
	"sap/ui/model/Filter",
	"sap/ui/model/FilterOperator",
	"sap/m/GroupHeaderListItem",
	"sap/ui/Device",
	"colgate/asm/planning/base/model/formatter",
	"colgate/asm/planning/base/model/grouper",
	"colgate/asm/planning/base/model/GroupSortState"
], function(BaseController, JSONModel, Filter, FilterOperator, GroupHeaderListItem, Device, formatter, grouper, GroupSortState) {
	"use strict";
	return BaseController.extend("colgate.asm.planning.base.controller.StatusChange", {
		formatter: formatter,
		/* =========================================================== */
		/* lifecycle methods                                           */
		/* =========================================================== */
		/**
		 * Called when the master list controller is instantiated. It sets up the event handling for the master/detail communication and other lifecycle tasks.
		 * @public
		 */
		onInit: function() {
			// Control state model
			this.getRouter().getRoute("statusChange").attachPatternMatched(this._onMasterMatched, this);
			var oViewModel = new JSONModel({});
			this.setModel(oViewModel, "masterView");
		},
		/* =========================================================== */
		/* event handlers                                              */
		/* =========================================================== */

		/**
		 * Navigates back in the browser history, if the entry was created by this app.
		 * If not, it navigates to the Fiori Launchpad home page
		 * @override
		 * @public
		 */
		onNavBack: function() {
			var oHistory = sap.ui.core.routing.History.getInstance(),
				sPreviousHash = oHistory.getPreviousHash(),
				oCrossAppNavigator = sap.ushell.Container.getService("CrossApplicationNavigation");
			if (sPreviousHash !== undefined) {
				// The history contains a previous entry
				history.go(-1);
			} else {
				// Navigate back to FLP home
				oCrossAppNavigator.toExternal({
					target: {
						shellHash: "#Shell-home"
					}
				});
			}
		},
		/**
		 * If the master route was hit (empty hash) we have to set
		 * the hash to to the first item in the list as soon as the
		 * listLoading is done and the first item in the list is known
		 * @private
		 */
		_onMasterMatched: function() {
		    if (this.getOwnerComponent().getModel("masterShared") && this.getOwnerComponent().getModel("masterShared").getData()) {
				if (this.getOwnerComponent().getModel("masterShared").getData().oInternalEvents.currentMode !== "Status") {
					this.getRouter().navTo("activities", {
						objectId: "Activities"
					}, true);
				} else {
				   this._showDetail();
				}
			} else {
				this.getRouter().navTo("activities", {
					objectId: "Activities"
				}, true);
			}
		},
		_initializeFixedValues: function() {
			// The success for this one handles itself, but you should set the initial division data.
			var oUserData = this.getOwnerComponent().getModel("UserData");
			var sDivision = oUserData.getProperty("/DivisionKey");
			var sHub = oUserData.getProperty("/HubKey");
			var sSub = oUserData.getProperty("/SubKey");
			var sFunction = oUserData.getProperty("/Function");
			var sChannel = oUserData.getProperty("/Channel");
			// GDH 5/23/2016 - Added for Category, Subcategory and Brand
			var sCategory = oUserData.getProperty("/Category");
			var sSubcategory = oUserData.getProperty("/SubCategory");
			var sBrand = oUserData.getProperty("/Brand");
			var oData = this.getOwnerComponent().getModel("masterShared").getProperty("/oMasterSelect");
			oData.DivisionKey = sDivision;
			oData.HubKey = sHub;
			oData.SubKey = sSub;
			oData.Function = sFunction;
			oData.Channel = sChannel;
			oData.Category = sCategory;
			oData.Subcategory = sSubcategory;
			oData.Brand = sBrand;
			return oData;
		},
		/**
		 * Shows the selected item on the detail page
		 * On phones a additional history entry is created
		 * @param {sap.m.ObjectListItem} oItem selected Item
		 * @private
		 */
		_showDetail: function(oItem) {
			//GDH - Receive events when screen is shown 
			var oData = this._initializeFixedValues();
			this.getOwnerComponent().getModel("masterShared").getData().oMasterSelect = oData;
			var oEventBus = sap.ui.getCore().getEventBus();
			oEventBus.publish("colgate.asm.planning.master.reinitialize", "ChangeStatus", oData);
		},
		/**
		 *@memberOf colgate.asm.planning.base.controller.StatusChange
		 */
		onCancel: function() {
			//This code was generated by the layout editor.
			var oEventBus = sap.ui.getCore().getEventBus();
			var oData = {};
			oEventBus.publish("colgate.asm.planning.master.button.pressed", "CancelStatus", oData);
		}
	});
});